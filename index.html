<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paper House | United Earth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0b0e11;
            --card-bg: #15191d;
            --primary: #4ea4f5;
            --text-main: #e9edef;
            --text-dim: #8696a0;
            --my-msg: #005c4b;
            --other-msg: #202c33;
        }

        body {
            margin: 0; padding: 0; background: var(--bg-color);
            color: var(--text-main); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* Top Header */
        header {
            background: var(--card-bg); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #222; z-index: 100;
        }

        .hub-title { font-weight: bold; color: var(--primary); letter-spacing: 1px; }
        #stats { font-size: 10px; color: var(--text-dim); }

        /* Chat Area */
        #world-map {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 12px;
            background: radial-gradient(circle at center, #1a1d21 0%, #0b0e11 100%);
        }

        .msg-container { display: flex; flex-direction: column; max-width: 80%; }
        .msg-container.me { align-self: flex-end; }
        .msg-container.others { align-self: flex-start; }

        .user-tag {
            display: flex; align-items: center; gap: 6px;
            font-size: 11px; margin-bottom: 4px; color: var(--text-dim);
        }

        .flag { font-size: 14px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
        .status-online { background: #00ff00; box-shadow: 0 0 5px #00ff00; }

        .bubble {
            padding: 10px 14px; border-radius: 15px; font-size: 14.5px;
            line-height: 1.5; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .me .bubble { background: var(--my-msg); border-top-right-radius: 2px; }
        .others .bubble { background: var(--other-msg); border-top-left-radius: 2px; }

        .meta-info {
            display: flex; justify-content: flex-end; gap: 5px;            font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 4px;
        }

        /* Input Area */
        .input-bar {
            background: var(--card-bg); padding: 12px;
            display: flex; gap: 10px; align-items: center;
        }

        #message-input {
            flex: 1; background: #2a2f32; border: none;
            color: white; padding: 12px 18px; border-radius: 25px; outline: none;
        }

        #send-btn {
            background: var(--primary); border: none; width: 45px; height: 45px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* Scrollbar */
        #world-map::-webkit-scrollbar { width: 4px; }
        #world-map::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>

    <header>
        <div class="hub-title">UNITED EARTH HUB</div>
        <div id="stats">Global Sync Active</div>
    </header>

    <div id="world-map"></div>

    <div class="input-bar">
        <input type="text" id="message-input" placeholder="Type a global message..." maxlength="1000">
        <button id="send-btn">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp, onValue, onDisconnect, set, query, limitToLast } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDMGU5X7BBp-C6tIl34Uuu5N9MXAVFTn7c",
        authDomain: "paper-house-inc.firebaseapp.com",
        projectId: "paper-house-inc",
        storageBucket: "paper-house-inc.firebasestorage.app",
        messagingSenderId: "658389836376",
        appId: "1:658389836376:web:2ab1e2743c593f4ca8e02d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const userId = String(tg.initDataUnsafe?.user?.id || "anonymous");
    const userName = tg.initDataUnsafe?.user?.first_name || "Guest";
    let userCountry = "üåç";
    // --- 1. GET GLOBAL LOCATION ---
    async function fetchLocation() {
        try {
            const res = await fetch('https://ipapi.co/json/');
            const data = await res.json();
            userCountry = data.country_emoji || "üåç";
        } catch (e) { console.log("Location blocked"); }
    }
    fetchLocation();

    // --- 2. PRESENCE SYSTEM ---
    const myStatusRef = ref(db, `presence/${userId}`);
    onValue(ref(db, '.info/connected'), (snap) => {
        if (snap.val() === true) {
            set(myStatusRef, { name: userName, status: 'online', country: userCountry, last: serverTimestamp() });
            onDisconnect(myStatusRef).set({ name: userName, status: 'offline', country: userCountry, last: serverTimestamp() });
        }
    });

    // --- 3. CHAT ENGINE ---
    const chatScreen = document.getElementById('world-map');
    const msgInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    function broadcast() {
        const text = msgInput.value.trim();
        if (!text) return;

        // Optimistic UI: The database is in Asia, so we don't wait. 
        // We push to Firebase and let it sync globally.
        push(ref(db, 'global_hub'), {
            userId, name: userName, text, country: userCountry, timestamp: serverTimestamp()
        });

        msgInput.value = "";
    }

    sendBtn.onclick = broadcast;
    msgInput.onkeypress = (e) => { if(e.key === 'Enter') broadcast(); };

    // --- 4. WORLD SYNC (The "Asia Fix") ---
    const hubQuery = query(ref(db, 'global_hub'), limitToLast(50));
    onChildAdded(hubQuery, (snapshot) => {
        const data = snapshot.val();
        renderMessage(data);
    });

    function renderMessage(data) {
        const isMe = data.userId === userId;
        const container = document.createElement('div');
        container.className = `msg-container ${isMe ? 'me' : 'others'}`;
        
        const date = data.timestamp ? new Date(data.timestamp) : new Date();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        container.innerHTML = `
            <div class="user-tag">
                <span class="status-dot s-dot-${data.userId}"></span>
                <span class="flag">${data.country || 'üåç'}</span>
                <b>${data.name}</b>
                <span class="seen-${data.userId}" style="font-size:8px"></span>
            </div>
            <div class="bubble">
                ${data.text}
                <div class="meta-info">${timeStr}</div>
            </div>
        `;

        chatScreen.appendChild(container);
        chatScreen.scrollTop = chatScreen.scrollHeight;

        // Live status sync for this specific user
        onValue(ref(db, `presence/${data.userId}`), (snap) => {
            const status = snap.val();
            const dot = container.querySelector(`.s-dot-${data.userId}`);
            const seen = container.querySelector(`.seen-${data.userId}`);
            if (status) {
                if (status.status === 'online') {
                    dot.className = "status-dot status-online";
                    seen.innerText = "";
                } else {
                    dot.className = "status-dot";
                    seen.innerText = formatTime(status.last);
                }
            }
        });
    }

    function formatTime(ts) {
        if(!ts) return "";
        const diff = (Date.now() - ts)/1000;
        if(diff < 60) return "just now";
        if(diff < 3600) return Math.floor(diff/60)+"m ago";
        return Math.floor(diff/3600)+"h ago";
    }

    // Global Statistics
    onValue(ref(db, 'presence'), (snap) => {
        document.getElementById('stats').innerText = `${snap.size} Earthlings Online`;
    });
</script>
</body>
</html>
